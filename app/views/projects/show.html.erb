<div class="row">
  <div class="col-md-8">
    <!-- Project Details Card -->
    <div class="card">
      <div class="card-header">
        <h4 class="card-title mb-0">
          <i class="bi bi-folder me-2"></i>
          <%= @project.name %>
        </h4>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-sm-3">
            <strong>Description:</strong>
          </div>
          <div class="col-sm-9">
            <%= @project.desc.presence || '<span class="text-muted">No description</span>'.html_safe %>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-3">
            <strong>Manager:</strong>
          </div>
          <div class="col-sm-9">
            <span class="badge bg-primary">
              <i class="bi bi-person-gear me-1"></i>
              <%= @project.manager.name %>
            </span>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-3">
            <strong>Created:</strong>
          </div>
          <div class="col-sm-9">
            <%= @project.created_at.strftime("%B %d, %Y") %>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-3">
            <strong>Team Size:</strong>
          </div>
          <div class="col-sm-9">
            <%= @project.users.count %> members
          </div>
        </div>
      </div>
    </div>

    <!-- Tickets Summary Card -->
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="bi bi-ticket-perforated me-2"></i>
          Tickets Summary
        </h5>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-3">
            <div class="border rounded p-3">
              <h4 class="text-primary"><%= @project.tickets.count %></h4>
              <small class="text-muted">Total Tickets</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="border rounded p-3">
              <h4 class="text-warning"><%= @project.tickets.bugs.count %></h4>
              <small class="text-muted">Bugs</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="border rounded p-3">
              <h4 class="text-info"><%= @project.tickets.features.count %></h4>
              <small class="text-muted">Features</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="border rounded p-3">
              <h4 class="text-success"><%= @project.tickets.where(status: ['completed', 'resolved']).count %></h4>
              <small class="text-muted">Resolved</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="col-md-4">
    <!-- Team Members Card -->
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="bi bi-people me-2"></i>
          Team Members
        </h5>
      </div>
      <div class="card-body">
        <!-- Manager -->
        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
          <div>
            <strong><%= @project.manager.name %></strong>
            <span class="badge bg-primary ms-2">Manager</span>
          </div>
        </div>

        <!-- Developers -->
        <% if @project.developers.any? %>
          <h6 class="text-muted mb-2">Developers (<%= @project.developers.count %>)</h6>
          <% @project.developers.each do |developer| %>
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
              <div>
                <%= developer.name %>
                <small class="text-muted d-block"><%= developer.email %></small>
              </div>
              <% if policy(@project).add_remove_users? %>
                <%= button_to "Remove", remove_user_project_path(@project, user_id: developer.id), 
                            method: :delete, 
                            class: "btn btn-sm btn-outline-danger",
                            form: { data: { turbo_confirm: "Remove #{developer.name} from project?" } } %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">No developers assigned</p>
        <% end %>

        <!-- QA Testers -->
        <% if @project.qas.any? %>
          <h6 class="text-muted mb-2 mt-3">QA Testers (<%= @project.qas.count %>)</h6>
          <% @project.qas.each do |qa| %>
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
              <div>
                <%= qa.name %>
                <small class="text-muted d-block"><%= qa.email %></small>
              </div>
              <% if policy(@project).add_remove_users? %>
                <%= button_to "Remove", remove_user_project_path(@project, user_id: qa.id), 
                            method: :delete, 
                            class: "btn btn-sm btn-outline-danger",
                            form: { data: { turbo_confirm: "Remove #{qa.name} from project?" } } %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">No QA testers assigned</p>
        <% end %>
      </div>
    </div>

    <!-- Add Users Card (for Managers) -->
    <% if policy(@project).add_remove_users? %>
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-person-plus me-2"></i>
            Add Team Members
          </h5>
        </div>
        <div class="card-body">
          <!-- Add Developer Form -->
          <% available_devs = @available_developers.where.not(id: @project.users.pluck(:id)) %>
          <% if available_devs.any? %>
            <%= form_with url: add_user_project_path(@project), method: :post, class: "mb-3" do |form| %>
              <div class="mb-2">
                <%= form.label :user_id, "Add Developer", class: "form-label small fw-bold" %>
                <%= form.collection_select :user_id, 
                                         available_devs, 
                                         :id, :name, 
                                         { include_blank: "Select Developer" }, 
                                         class: "form-select form-select-sm" %>
              </div>
              <%= form.submit "Add Developer", class: "btn btn-success btn-sm w-100" %>
            <% end %>
          <% else %>
            <p class="text-muted small">All developers are assigned</p>
          <% end %>

          <!-- Add QA Form -->
          <% available_qas = @available_qas.where.not(id: @project.users.pluck(:id)) %>
          <% if available_qas.any? %>
            <%= form_with url: add_user_project_path(@project), method: :post do |form| %>
              <div class="mb-2">
                <%= form.label :user_id, "Add QA Tester", class: "form-label small fw-bold" %>
                <%= form.collection_select :user_id, 
                                         available_qas, 
                                         :id, :name, 
                                         { include_blank: "Select QA Tester" }, 
                                         class: "form-select form-select-sm" %>
              </div>
              <%= form.submit "Add QA", class: "btn btn-success btn-sm w-100" %>
            <% end %>
          <% else %>
            <p class="text-muted small">All QA testers are assigned</p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Action Buttons -->
<div class="mt-4">
  <% if policy(@project).edit? %>
    <%= link_to edit_project_path(@project), class: "btn btn-warning" do %>
      <i class="bi bi-pencil me-1"></i>Edit Project
    <% end %>
  <% end %>
  
  <%= link_to projects_path, class: "btn btn-secondary" do %>
    <i class="bi bi-arrow-left me-1"></i>Back to Projects
  <% end %>

  <% if policy(@project).destroy? %>
    <%= button_to @project, method: :delete, 
                class: "btn btn-danger float-end",
                form: { data: { turbo_confirm: "Are you sure you want to delete this project and all its tickets?" } } do %>
      <i class="bi bi-trash me-1">Delete Project</i>
    <% end %>
  <% end %>
</div>